{
  "entities": {
    "Client": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Client",
      "type": "object",
      "description": "Represents a client of the media production company, storing contact information and project history.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Client entity."
        },
        "name": {
          "type": "string",
          "description": "The official name of the client company or individual."
        },
        "contactPerson": {
          "type": "string",
          "description": "The primary contact person at the client organization."
        },
        "email": {
          "type": "string",
          "description": "The email address of the primary contact person.",
          "format": "email"
        },
        "phone": {
          "type": "string",
          "description": "The phone number of the primary contact person."
        },
        "address": {
          "type": "string",
          "description": "The physical address of the client."
        },
        "website": {
          "type": "string",
          "description": "The official website URL of the client.",
          "format": "uri"
        },
        "description": {
          "type": "string",
          "description": "A detailed description or notes about the client."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the client record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the client record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "contactPerson",
        "email",
        "createdAt",
        "updatedAt"
      ]
    },
    "TeamMember": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TeamMember",
      "type": "object",
      "description": "Represents a member of the MediaFlow team with their contact and role information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TeamMember entity."
        },
        "firstName": {
          "type": "string",
          "description": "The first name of the team member."
        },
        "lastName": {
          "type": "string",
          "description": "The last name of the team member."
        },
        "email": {
          "type": "string",
          "description": "The professional email address of the team member.",
          "format": "email"
        },
        "phone": {
          "type": "string",
          "description": "The contact phone number of the team member."
        },
        "title": {
          "type": "string",
          "description": "The job title or position of the team member."
        },
        "roleId": {
          "type": "string",
          "description": "Reference to the Role assigned to this team member. (Relationship: Role 1:N TeamMember)"
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates if the team member is currently active."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the team member record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the team member record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email",
        "roleId",
        "isActive",
        "createdAt",
        "updatedAt"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Defines a role within the application for role-based access control, specifying permissions for team members.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Role entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the role (e.g., 'Admin', 'Project Manager', 'Sales')."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the role's responsibilities and permissions."
        },
        "permissions": {
          "type": "array",
          "description": "A list of permission strings associated with this role (e.g., 'read_client', 'create_project').",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the role record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the role record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "permissions",
        "createdAt",
        "updatedAt"
      ]
    },
    "Project": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Project",
      "type": "object",
      "description": "Represents a media production project, tracking its scope, timeline, and associated client and team.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Project entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the project."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the project's objectives and scope."
        },
        "clientId": {
          "type": "string",
          "description": "Reference to the client associated with this project. (Relationship: Client 1:N Project)"
        },
        "projectManagerId": {
          "type": "string",
          "description": "Reference to the team member designated as the project manager. (Relationship: TeamMember 1:N Project)"
        },
        "startDate": {
          "type": "string",
          "description": "The planned start date of the project.",
          "format": "date"
        },
        "endDate": {
          "type": "string",
          "description": "The planned end date of the project.",
          "format": "date"
        },
        "actualEndDate": {
          "type": "string",
          "description": "The actual completion date of the project.",
          "format": "date"
        },
        "status": {
          "type": "string",
          "description": "The current status of the project (e.g., 'Planned', 'In Progress', 'Completed', 'On Hold')."
        },
        "budget": {
          "type": "number",
          "description": "The allocated budget for the project."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the project record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the project record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "clientId",
        "projectManagerId",
        "startDate",
        "status",
        "budget",
        "createdAt",
        "updatedAt"
      ]
    },
    "Task": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Task",
      "type": "object",
      "description": "Represents a specific task within a project, assigned to a team member with deadlines and status.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Task entity."
        },
        "name": {
          "type": "string",
          "description": "The name or title of the task."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the task."
        },
        "projectId": {
          "type": "string",
          "description": "Reference to the project this task belongs to. (Relationship: Project 1:N Task)"
        },
        "assigneeId": {
          "type": "string",
          "description": "Reference to the team member assigned to complete this task. (Relationship: TeamMember 1:N Task)"
        },
        "dueDate": {
          "type": "string",
          "description": "The deadline for completing the task.",
          "format": "date"
        },
        "priority": {
          "type": "string",
          "description": "The priority level of the task (e.g., 'Low', 'Medium', 'High')."
        },
        "status": {
          "type": "string",
          "description": "The current status of the task (e.g., 'To Do', 'In Progress', 'Review', 'Done')."
        },
        "estimatedHours": {
          "type": "number",
          "description": "The estimated number of hours required to complete the task."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the task record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the task record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "projectId",
        "assigneeId",
        "dueDate",
        "status",
        "createdAt",
        "updatedAt"
      ]
    },
    "TimeEntry": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TimeEntry",
      "type": "object",
      "description": "Records the time a team member spent on a specific task or project, used for billing and tracking.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TimeEntry entity."
        },
        "teamMemberId": {
          "type": "string",
          "description": "Reference to the team member who logged the time. (Relationship: TeamMember 1:N TimeEntry)"
        },
        "taskId": {
          "type": "string",
          "description": "Reference to the task on which time was spent (optional, if time is logged directly to a project). (Relationship: Task 1:N TimeEntry)"
        },
        "projectId": {
          "type": "string",
          "description": "Reference to the project on which time was spent. (Relationship: Project 1:N TimeEntry)"
        },
        "date": {
          "type": "string",
          "description": "The date when the time was logged.",
          "format": "date"
        },
        "hours": {
          "type": "number",
          "description": "The number of hours logged for this entry."
        },
        "description": {
          "type": "string",
          "description": "A brief description of the work performed during this time entry."
        },
        "isBillable": {
          "type": "boolean",
          "description": "Indicates if these hours are billable to the client."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the time entry record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the time entry record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "teamMemberId",
        "projectId",
        "date",
        "hours",
        "description",
        "isBillable",
        "createdAt",
        "updatedAt"
      ]
    },
    "Invoice": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Invoice",
      "type": "object",
      "description": "Represents a professional invoice generated for a client, detailing services rendered and payment status.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Invoice entity."
        },
        "invoiceNumber": {
          "type": "string",
          "description": "A unique, human-readable invoice number."
        },
        "clientId": {
          "type": "string",
          "description": "Reference to the client to whom this invoice is issued. (Relationship: Client 1:N Invoice)"
        },
        "projectId": {
          "type": "string",
          "description": "Reference to the project this invoice is primarily for (optional). (Relationship: Project 1:N Invoice)"
        },
        "issueDate": {
          "type": "string",
          "description": "The date when the invoice was issued.",
          "format": "date"
        },
        "dueDate": {
          "type": "string",
          "description": "The date by which the invoice payment is due.",
          "format": "date"
        },
        "totalAmount": {
          "type": "number",
          "description": "The total monetary amount of the invoice."
        },
        "currency": {
          "type": "string",
          "description": "The currency in which the invoice is denominated (e.g., 'USD', 'EUR')."
        },
        "status": {
          "type": "string",
          "description": "The current payment status of the invoice (e.g., 'Draft', 'Sent', 'Paid', 'Overdue')."
        },
        "paymentDate": {
          "type": "string",
          "description": "The actual date when the payment for this invoice was received.",
          "format": "date"
        },
        "notes": {
          "type": "string",
          "description": "Any additional notes or comments related to the invoice."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the invoice record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the invoice record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "invoiceNumber",
        "clientId",
        "issueDate",
        "dueDate",
        "totalAmount",
        "currency",
        "status",
        "createdAt",
        "updatedAt"
      ]
    },
    "LineItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "LineItem",
      "type": "object",
      "description": "Represents a single item or service listed on an invoice.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the LineItem entity."
        },
        "invoiceId": {
          "type": "string",
          "description": "Reference to the invoice this line item belongs to. (Relationship: Invoice 1:N LineItem)"
        },
        "description": {
          "type": "string",
          "description": "A description of the service or product provided."
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the item or hours of service."
        },
        "unitPrice": {
          "type": "number",
          "description": "The price per unit or per hour."
        },
        "total": {
          "type": "number",
          "description": "The total amount for this line item (quantity * unitPrice)."
        },
        "timeEntryIds": {
          "type": "array",
          "description": "References to TimeEntry entities that contribute to this line item (for hourly billing). (Relationship: TimeEntry N:N LineItem)",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the line item record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the line item record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "invoiceId",
        "description",
        "quantity",
        "unitPrice",
        "total",
        "createdAt",
        "updatedAt"
      ]
    },
    "Lead": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Lead",
      "type": "object",
      "description": "Represents a potential client or sales opportunity, tracking its progress through the sales pipeline.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Lead entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the potential client company or contact person."
        },
        "email": {
          "type": "string",
          "description": "The email address of the lead's contact person.",
          "format": "email"
        },
        "phone": {
          "type": "string",
          "description": "The phone number of the lead's contact person."
        },
        "source": {
          "type": "string",
          "description": "The origin of the lead (e.g., 'Website', 'Referral', 'Marketing Campaign')."
        },
        "status": {
          "type": "string",
          "description": "The current status of the lead in the sales pipeline (e.g., 'New', 'Contacted', 'Qualified', 'Converted', 'Lost')."
        },
        "estimatedValue": {
          "type": "number",
          "description": "The estimated monetary value of the potential business from this lead."
        },
        "probability": {
          "type": "number",
          "description": "The estimated probability (0-100%) of converting this lead into a client."
        },
        "assignedToId": {
          "type": "string",
          "description": "Reference to the team member (sales representative) responsible for this lead. (Relationship: TeamMember 1:N Lead)"
        },
        "notes": {
          "type": "string",
          "description": "Any additional notes or comments regarding the lead."
        },
        "convertedToClientId": {
          "type": "string",
          "description": "Reference to the Client entity if this lead was successfully converted. (Relationship: Client 1:1 Lead)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the lead record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the lead record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "source",
        "status",
        "assignedToId",
        "createdAt",
        "updatedAt"
      ]
    },
    "FollowUp": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "FollowUp",
      "type": "object",
      "description": "Represents a scheduled or completed follow-up activity for clients or leads, part of marketing and sales efforts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the FollowUp entity."
        },
        "subject": {
          "type": "string",
          "description": "A brief subject or title for the follow-up activity."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the follow-up activity."
        },
        "followUpType": {
          "type": "string",
          "description": "The type of follow-up activity (e.g., 'Call', 'Email', 'Meeting', 'Proposal Submission')."
        },
        "scheduledDate": {
          "type": "string",
          "description": "The date and time when the follow-up is scheduled.",
          "format": "date-time"
        },
        "completedDate": {
          "type": "string",
          "description": "The date and time when the follow-up was completed.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "The current status of the follow-up (e.g., 'Scheduled', 'Completed', 'Cancelled', 'Rescheduled')."
        },
        "assignedToId": {
          "type": "string",
          "description": "Reference to the team member responsible for this follow-up. (Relationship: TeamMember 1:N FollowUp)"
        },
        "clientId": {
          "type": "string",
          "description": "Reference to the Client entity if this follow-up is for an existing client. (Relationship: Client 1:N FollowUp)"
        },
        "leadId": {
          "type": "string",
          "description": "Reference to the Lead entity if this follow-up is for a potential lead. (Relationship: Lead 1:N FollowUp)"
        },
        "relatedProjectId": {
          "type": "string",
          "description": "Reference to a Project entity if this follow-up is related to a specific project. (Relationship: Project 1:N FollowUp)"
        },
        "notes": {
          "type": "string",
          "description": "Any additional notes or outcomes from the follow-up activity."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the follow-up record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the follow-up record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "subject",
        "followUpType",
        "scheduledDate",
        "status",
        "assignedToId",
        "createdAt",
        "updatedAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/teamMembers/{teamMemberId}",
        "definition": {
          "entityName": "TeamMember",
          "schema": {
            "$ref": "#/backend/entities/TeamMember"
          },
          "description": "Collection for individual team member profiles. `teamMemberId` corresponds to `request.auth.uid`. Accessed by the user themselves for their profile, or by authorized roles (e.g., Admins) for management."
        }
      },
      {
        "path": "/roles/{roleId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Reference collection defining application roles and their general permissions. Access primarily restricted to administrative users for definition purposes."
        }
      },
      {
        "path": "/global_roles_admin/{userId}",
        "definition": {
          "entityName": "TeamMember",
          "schema": {
            "$ref": "#/backend/entities/TeamMember"
          },
          "description": "Collection for assigning global 'Admin' role. The existence of a document at `/global_roles_admin/{request.auth.uid}` grants administrative privileges. The document itself may be empty or contain minimal TeamMember data for reference, adhering to the 'Existence over Content' principle for DBAC."
        }
      },
      {
        "path": "/global_roles_salesManager/{userId}",
        "definition": {
          "entityName": "TeamMember",
          "schema": {
            "$ref": "#/backend/entities/TeamMember"
          },
          "description": "Collection for assigning global 'Sales Manager' role. The existence of a document at `/global_roles_salesManager/{request.auth.uid}` grants sales management privileges. The document itself may be empty or contain minimal TeamMember data for reference, adhering to the 'Existence over Content' principle for DBAC."
        }
      },
      {
        "path": "/global_roles_projectManagerGlobal/{userId}",
        "definition": {
          "entityName": "TeamMember",
          "schema": {
            "$ref": "#/backend/entities/TeamMember"
          },
          "description": "Collection for assigning a global 'Project Manager' role, granting broad access to project-related data. The existence of a document at `/global_roles_projectManagerGlobal/{request.auth.uid}` grants these privileges. The document itself may be empty or contain minimal TeamMember data for reference, adhering to the 'Existence over Content' principle for DBAC."
        }
      },
      {
        "path": "/clients/{clientId}",
        "definition": {
          "entityName": "Client",
          "schema": {
            "$ref": "#/backend/entities/Client"
          },
          "description": "Collection for client information. Access controlled by authorized roles (e.g., global Project Managers, Sales Managers, Admins). No denormalization needed for authorization in this collection, as access is role-based rather than hierarchical."
        }
      },
      {
        "path": "/projects/{projectId}",
        "definition": {
          "entityName": "Project",
          "schema": {
            "$ref": "#/backend/entities/Project"
          },
          "description": "Collection for media production projects. Includes denormalized 'clientId', 'projectManagerId', and 'projectMemberIds' (array of UIDs) for authorization independence. Access is granted to the 'projectManagerId', members in 'projectMemberIds', or global roles."
        }
      },
      {
        "path": "/projects/{projectId}/tasks/{taskId}",
        "definition": {
          "entityName": "Task",
          "schema": {
            "$ref": "#/backend/entities/Task"
          },
          "description": "Subcollection for tasks within a specific project. Includes denormalized 'projectId', 'projectManagerId', 'projectMemberIds', and 'assigneeId' for authorization independence, enabling rules to check access without fetching the parent project."
        }
      },
      {
        "path": "/timeEntries/{timeEntryId}",
        "definition": {
          "entityName": "TimeEntry",
          "schema": {
            "$ref": "#/backend/entities/TimeEntry"
          },
          "description": "Collection for tracking time spent by team members. Includes denormalized 'teamMemberId' (the logger), 'projectId', 'projectManagerId' (from Project), and 'taskAssigneeId' (from Task if linked) for authorization independence. Allows users to manage their own entries and project managers to view entries for their projects."
        }
      },
      {
        "path": "/invoices/{invoiceId}",
        "definition": {
          "entityName": "Invoice",
          "schema": {
            "$ref": "#/backend/entities/Invoice"
          },
          "description": "Collection for client invoices. Includes denormalized 'clientId', 'projectId' (if linked), and 'projectManagerId' (from Project) for authorization independence, allowing access checks based on client or project association."
        }
      },
      {
        "path": "/invoices/{invoiceId}/lineItems/{lineItemId}",
        "definition": {
          "entityName": "LineItem",
          "schema": {
            "$ref": "#/backend/entities/LineItem"
          },
          "description": "Subcollection for individual line items within an invoice. Includes denormalized 'invoiceId', 'clientId', 'projectId', and 'projectManagerId' for authorization independence, inheriting access from the parent invoice and linked project."
        }
      },
      {
        "path": "/leads/{leadId}",
        "definition": {
          "entityName": "Lead",
          "schema": {
            "$ref": "#/backend/entities/Lead"
          },
          "description": "Collection for potential client leads. Access is primarily controlled by the 'assignedToId' (sales representative) and global Sales Manager/Admin roles. No complex hierarchical denormalization required for authorization beyond the existing 'assignedToId' field."
        }
      },
      {
        "path": "/followUps/{followUpId}",
        "definition": {
          "entityName": "FollowUp",
          "schema": {
            "$ref": "#/backend/entities/FollowUp"
          },
          "description": "Collection for marketing and sales follow-up activities (Strategic Pipeline module). Includes denormalized 'assignedToId' (the owner of the follow-up). Also denormalizes 'clientProjectManagerIds' (if linked to Client), 'leadAssignedToId' (if linked to Lead), and 'projectManagerId' along with 'projectMemberIds' (if linked to Project) for robust authorization independence."
        }
      }
    ],
    "reasoning": "The Firestore data structure for MediaFlow is designed with a strong emphasis on Authorization Independence, enabling robust and debuggable security rules. This is achieved primarily through strategic denormalization and structural segregation, ensuring that all authorization-relevant data is present within the document being accessed, eliminating the need for `get()` operations in security rules.\n\n**Authorization Independence (CRITICAL):**\n\n1.  **Project Context Denormalization:**\n    *   **Project Documents (`/projects/{projectId}`):** Each `Project` document will store its `clientId` and `projectManagerId`. Crucially, a new field `projectMemberIds` (an array of `teamMemberId` UIDs) will be added to `Project` documents to explicitly list all team members with access, facilitating collaborative authorization without relying on parent `Client` data.\n    *   **Task Documents (`/projects/{projectId}/tasks/{taskId}`):** `Task` documents will denormalize `projectId`, `projectManagerId`, and `projectMemberIds` from their parent `Project`. They will also include `assigneeId`. This allows security rules for tasks to verify if `request.auth.uid` is the project manager, task assignee, or a project member directly from the task document itself, avoiding a `get()` call to the parent `Project`.\n2.  **Time Entry Context Denormalization:**\n    *   **TimeEntry Documents (`/timeEntries/{timeEntryId}`):** These documents will denormalize `teamMemberId` (the user who logged the time), `projectId`, and `projectManagerId` (from the associated `Project`). If linked to a specific `taskId`, it will also denormalize `taskAssigneeId`. This ensures that rules can check ownership (by `teamMemberId`) or management rights (by `projectManagerId`) directly within the `TimeEntry` document.\n3.  **Invoice and Line Item Context Denormalization:**\n    *   **Invoice Documents (`/invoices/{invoiceId}`):** Each `Invoice` document will denormalize `clientId` and, if related to a project, `projectId` and `projectManagerId` (from the `Project` entity). This ensures that authorization to invoices can be determined by the client or project relationship without additional `get()` calls.\n    *   **LineItem Documents (`/invoices/{invoiceId}/lineItems/{lineItemId}`):** These documents will denormalize `invoiceId`, `clientId`, `projectId`, and `projectManagerId` from their parent `Invoice` and its linked `Project`. This provides all necessary authorization context at the `LineItem` level.\n4.  **Follow-Up Module Denormalization (Strategic Pipeline):**\n    *   **FollowUp Documents (`/followUps/{followUpId}`):** Given the `FollowUp` entity can relate to a `Client`, `Lead`, or `Project`, it requires significant denormalization for authorization. Each `FollowUp` document will contain `assignedToId` (the direct owner). Additionally, it will denormalize relevant IDs from linked entities:\n        *   If `clientId` is present: `clientProjectManagerIds` (an array of UIDs for client-related managers).\n        *   If `leadId` is present: `leadAssignedToId` (the `assignedToId` from the linked `Lead`).\n        *   If `relatedProjectId` is present: `projectManagerId` and `projectMemberIds` (from the linked `Project`).\n    *   This design ensures that a team member can access a `FollowUp` if they are its `assignedToId`, or if they are associated with the linked client, lead, or project through the denormalized IDs.\n\n**QAPs (Rules are not Filters):**\n\n1.  **Structural Segregation:** Each collection (`/teamMembers`, `/roles`, `/clients`, `/projects`, `/leads`, `/followUps`, `/timeEntries`, `/invoices`, and `/invoices/{invoiceId}/lineItems`) is designed to hold documents of a uniform security posture. For example, all documents in `/leads` are sales leads, and their access rules (e.g., `assignedToId` or global `SalesManager` role) apply homogeneously.\n2.  **Path-Based Ownership:** Personal data, like a team member's own profile, is secured via `teamMembers/{teamMemberId}` where `teamMemberId` directly corresponds to `request.auth.uid`, enabling simple `allow read, write: if request.auth.uid == teamMemberId;` rules.\n3.  **Denormalized Fields for Queryable Access:** By embedding `projectManagerId`, `assigneeId`, `leadAssignedToId`, `teamMemberIds`, and `clientProjectManagerIds` directly into documents, secure `list` operations become highly efficient. For example, a project manager can query `tasks` where `projectManagerId == request.auth.uid` and the security rule can evaluate this condition without filtering or additional reads, ensuring only authorized results are returned.\n4.  **DBAC (Existence over Content) for Global Roles:** Dedicated top-level collections like `/global_roles_admin/{userId}` and `/global_roles_salesManager/{userId}` are used for granting global administrative or managerial access. The mere existence of a document for `request.auth.uid` in these collections grants the associated role, allowing straightforward rules like `allow list: if exists(/databases/$(database)/documents/global_roles_admin/$(request.auth.uid));`. This completely avoids `get()` calls for global role checks.\n\n**Clarity of Intent and Predictability:**\n\n*   **Explicit State Modeling:** Entities like `Project`, `Task`, `Invoice`, and `FollowUp` utilize a dedicated `status` field (e.g., 'Planned', 'In Progress', 'Completed'; 'Scheduled', 'Completed', 'Cancelled') to clearly define their lifecycle stage.\n*   **Radical Consistency:** Standardized authorization fields (`assignedToId`, `projectManagerId`, `projectMemberIds`) and descriptive wildcards (`{clientId}`, `{projectId}`) maintain high predictability and make rules easier to write and debug. Timestamps (`createdAt`, `updatedAt`) are consistently applied to all entities."
  }
}