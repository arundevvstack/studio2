rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * MEDIAFLOW SECURITY MODEL (PROTOTYPE VERSION)
     * 
     * For the prototype phase, we permit any authenticated user to act as a team member.
     * This avoids blocks when the 'team_members' collection is empty or a user has 
     * just signed in anonymously.
     */

    // --- GLOBAL HELPER FUNCTIONS ---

    /** @description Checks if the user is authenticated with a valid UID. */
    function isSignedIn() {
      return request.auth != null;
    }

    /** @description Checks if the provided ID matches the authenticated user's UID. */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /** @description Checks if the document exists and the current user is the owner. */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    /** 
     * @description Prototype version: Any signed-in user is considered a team member.
     * In production, this would check for an actual document in /team_members.
     */
    function isTeamMember() {
      return isSignedIn();
    }

    /** @description Checks project-level membership using denormalized maps. */
    function isProjectCollaborator(data) {
      return isSignedIn() && (
        (data.members != null && data.members[request.auth.uid] != null) || 
        (data.projectMembers != null && data.projectMembers[request.auth.uid] != null)
      );
    }

    // --- COLLECTION RULES ---

    match /roles/{roleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isTeamMember();
    }

    match /team_members/{teamMemberId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(teamMemberId) && request.resource.data.id == teamMemberId;
      allow update: if isExistingOwner(teamMemberId) && request.resource.data.id == resource.data.id;
      allow delete: if false;
    }

    match /clients/{clientId} {
      allow get, list: if isSignedIn();
      allow create: if isTeamMember() && request.resource.data.id == clientId;
      allow update: if isTeamMember() && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isTeamMember() && resource != null;
    }

    match /projects/{projectId} {
      allow get, list: if isProjectCollaborator(resource.data) || isTeamMember();
      allow create: if isTeamMember() && request.resource.data.id == projectId;
      allow update: if (isProjectCollaborator(resource.data) || isTeamMember()) && request.resource.data.id == resource.data.id;
      allow delete: if isTeamMember() && resource != null;

      match /tasks/{taskId} {
        allow get, list: if isProjectCollaborator(resource.data) || isTeamMember();
        allow create: if (isProjectCollaborator(request.resource.data) || isTeamMember()) && request.resource.data.projectId == projectId;
        allow update: if (isProjectCollaborator(resource.data) || isTeamMember()) && request.resource.data.projectId == resource.data.projectId;
        allow delete: if isProjectCollaborator(resource.data) || isTeamMember();

        match /time_entries/{timeEntryId} {
          allow get, list: if isProjectCollaborator(resource.data) || isTeamMember();
          allow create: if (isProjectCollaborator(request.resource.data) || isTeamMember())
                        && isOwner(request.resource.data.teamMemberId)
                        && request.resource.data.projectId == projectId
                        && request.resource.data.taskId == taskId;
          allow update: if isExistingOwner(resource.data.teamMemberId) 
                        && request.resource.data.teamMemberId == resource.data.teamMemberId;
          allow delete: if isExistingOwner(resource.data.teamMemberId);
        }
      }
    }

    match /clients/{clientId}/invoices/{invoiceId} {
      allow get, list: if isProjectCollaborator(resource.data) || isTeamMember();
      allow create: if isTeamMember() && request.resource.data.clientId == clientId;
      allow update: if isTeamMember() && resource != null && request.resource.data.clientId == resource.data.clientId;
      allow delete: if isTeamMember() && resource != null;

      match /line_items/{lineItemId} {
        allow get, list: if isProjectCollaborator(resource.data) || isTeamMember();
        allow create: if isTeamMember() && request.resource.data.invoiceId == invoiceId;
        allow update: if isTeamMember() && resource != null && request.resource.data.invoiceId == resource.data.invoiceId;
        allow delete: if isTeamMember() && resource != null;
      }
    }

    match /communication_logs/{logId} {
      allow get, list: if isOwner(resource.data.teamMemberId) || isProjectCollaborator(resource.data) || isTeamMember();
      allow create: if isOwner(request.resource.data.teamMemberId);
      allow update: if isExistingOwner(resource.data.teamMemberId) && request.resource.data.teamMemberId == resource.data.teamMemberId;
      allow delete: if isExistingOwner(resource.data.teamMemberId);
    }
  }
}