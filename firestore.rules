rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE PHILOSOPHY
     * This ruleset implements a robust Project-Based Access Control (PBAC) model combined with a 
     * global Administrative layer. It prioritizes "Authorization Independence" by leveraging 
     * denormalized member maps on documents, ensuring that security checks are performant 
     * and compatible with complex queries.
     *
     * DATA STRUCTURE
     * - Global Admin Access: Controlled via the /admin_users marker collection.
     * - User Profiles: Stored in /teamMembers.
     * - Project Ecosystem: /projects is the root of most activity, with tasks, tickets, and 
     *   time entries nested as subcollections for logical grouping.
     * - Billing: /invoices are top-level but linked to projects via denormalized metadata.
     * - Pipeline: leads, campaigns, and followUps manage the sales engine.
     */

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isProjectMember(data) {
      return isSignedIn() && data.projectMembers[request.auth.uid] != null;
    }

    function isProjectManager(data) {
      return isSignedIn() && data.projectMembers[request.auth.uid] == 'manager';
    }

    // --- Collection Rules ---

    /** @description Pipeline engine data rules. */
    match /leads/{leadId} {
      allow read, write: if isSignedIn();
    }
    match /campaigns/{campaignId} {
      allow read, write: if isSignedIn();
    }
    match /followUps/{followUpId} {
      allow read, write: if isSignedIn();
    }

    match /admin_users/{teamMemberId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    match /teamMembers/{teamMemberId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(teamMemberId) && request.resource.data.id == teamMemberId;
      allow update: if (isOwner(teamMemberId) || isAdmin()) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && resource != null;
    }

    match /clients/{clientId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.id == clientId;
      allow update: if (isAdmin() || isSignedIn()) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && resource != null;
    }

    match /projects/{projectId} {
      allow get: if isAdmin() || isProjectMember(resource.data) || isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.id == projectId;
      allow update: if (isAdmin() || isProjectManager(resource.data) || isSignedIn()) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && resource != null;

      match /tasks/{taskId} {
        allow read, write: if isSignedIn();
      }

      match /tickets/{ticketId} {
        allow read, write: if isSignedIn();
      }

      match /timeEntries/{timeEntryId} {
        allow read, write: if isSignedIn();
      }
    }

    match /invoices/{invoiceId} {
      allow get: if isAdmin() || isProjectMember(resource.data) || isSignedIn();
      allow list: if isSignedIn();
      allow create: if (isAdmin() || isSignedIn()) && request.resource.data.id == invoiceId;
      allow update: if (isAdmin() || isSignedIn()) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && resource != null;

      match /lineItems/{lineItemId} {
        allow read, write: if isSignedIn();
      }
    }
  }
}