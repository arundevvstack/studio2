rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE PHILOSOPHY
     * This ruleset implements a robust, role-based and ownership-based security model for the MediaFlow production platform. 
     * It prioritizes "Authorization Independence" by utilizing denormalized fields (like projectManagerId or projectMemberIds) 
     * directly on documents to ensure high-performance security checks without excessive database lookups.
     *
     * DATA STRUCTURE
     * - Personal profiles are stored under /teamMembers/{userId}.
     * - Global administrative and managerial roles are managed via dedicated 'global_roles' collections for Database-Based Access Control (DBAC).
     * - Business data (Clients, Projects, Leads, FollowUps) are top-level collections secured by a mix of global roles and specific ownership/participation fields.
     * - Hierarchical data (Tasks, LineItems) are subcollections that inherit or verify access context from their parent documents.
     *
     * KEY SECURITY DECISIONS
     * - PROTOTYPING MODE: This ruleset strictly enforces AUTHORIZATION (who can access) but is flexible on DATA SHAPE (field types/schemas) to allow rapid iteration.
     * - AUTH-FIRST: All requests must be authenticated.
     * - IMMUTABILITY: Critical relational fields (IDs, owner IDs) are enforced as immutable during updates to prevent data corruption or security bypasses.
     * - GLOBAL ROLES: Admin, Sales Manager, and Global Project Manager roles are verified via the existence of documents in specific global role collections.
     * - DENORMALIZATION: Authorization fields are duplicated onto sub-resources to allow for fast, direct security evaluations.
     */

    // --- HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    // DBAC Role Helpers
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/global_roles_admin/$(request.auth.uid));
    }

    function isSalesManager() {
      return isSignedIn() && exists(/databases/$(database)/documents/global_roles_salesManager/$(request.auth.uid));
    }

    function isGlobalPM() {
      return isSignedIn() && exists(/databases/$(database)/documents/global_roles_projectManagerGlobal/$(request.auth.uid));
    }

    // Shared Access Helpers
    function isProjectMember(data) {
      return isSignedIn() && (request.auth.uid == data.projectManagerId || request.auth.uid in data.projectMemberIds);
    }

    // --- COLLECTION RULES ---

    /**
     * @description Rules for individual team member profiles.
     * @path /teamMembers/{teamMemberId}
     * @allow Authenticated user (get, create, update) if their UID matches the path. Admin (list, delete).
     * @deny Non-owner user attempting to read/write another user's profile.
     * @principle Self-creation and ownership for profile management.
     */
    match /teamMembers/{teamMemberId} {
      allow get: if isOwner(teamMemberId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(teamMemberId) && request.resource.data.id == teamMemberId;
      allow update: if isExistingOwner(teamMemberId) && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Reference collection for application-wide role definitions.
     * @path /roles/{roleId}
     * @allow Any signed-in user (get, list). Admin only (create, update, delete).
     * @deny Non-admin user attempting to modify roles.
     * @principle Role definitions are public-read for the app but restricted-write.
     */
    match /roles/{roleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description DBAC collections for global role assignments.
     * @path /global_roles_admin/{userId}, /global_roles_salesManager/{userId}, /global_roles_projectManagerGlobal/{userId}
     * @allow Signed-in users (get) to check their own role status. Admin only (list, create, update, delete).
     * @deny Non-admin user attempting to escalate privileges or list all admins.
     * @principle Existence-over-content pattern for high-performance role checks.
     */
    match /global_roles_admin/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list, create, update, delete: if isAdmin();
    }
    match /global_roles_salesManager/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list, create, update, delete: if isAdmin();
    }
    match /global_roles_projectManagerGlobal/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list, create, update, delete: if isAdmin();
    }

    /**
     * @description Collection for client information.
     * @path /clients/{clientId}
     * @allow Managers and Admins (get, list, create, update). Admin only (delete).
     * @deny Standard team members without global management roles.
     * @principle Role-based access for core business entities.
     */
    match /clients/{clientId} {
      allow get, list: if isAdmin() || isGlobalPM() || isSalesManager();
      allow create, update: if isAdmin() || isGlobalPM() || isSalesManager();
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Media production projects, utilizing shared access maps.
     * @path /projects/{projectId}
     * @allow Project managers, listed members, and global admins (get, list, update). Admins and Global PMs (create, delete).
     * @deny Users not explicitly associated with the project.
     * @principle Shared access model via denormalized project member IDs.
     */
    match /projects/{projectId} {
      allow get: if isAdmin() || isGlobalPM() || isProjectMember(resource.data);
      allow list: if isSignedIn();
      allow create: if isAdmin() || isGlobalPM();
      allow update: if resource != null && (isAdmin() || isGlobalPM() || request.auth.uid == resource.data.projectManagerId);
      allow delete: if isAdmin() && resource != null;

      /**
       * @description Tasks within a project. Inherits/checks project context.
       * @path /projects/{projectId}/tasks/{taskId}
       * @allow Project members or task assignee (get, update). Project Manager (create, delete).
       * @deny Users outside the project or not assigned to the task.
       * @principle Subcollection access secured by denormalized parent context.
       */
      match /tasks/{taskId} {
        allow get: if isAdmin() || isGlobalPM() || isProjectMember(resource.data) || request.auth.uid == resource.data.assigneeId;
        allow list: if isSignedIn(); 
        allow create: if (isAdmin() || isGlobalPM() || request.auth.uid == request.resource.data.projectManagerId) && request.resource.data.projectId == projectId;
        allow update: if resource != null && (isAdmin() || isGlobalPM() || request.auth.uid == resource.data.projectManagerId || request.auth.uid == resource.data.assigneeId) && request.resource.data.projectId == resource.data.projectId;
        allow delete: if resource != null && (isAdmin() || isGlobalPM() || request.auth.uid == resource.data.projectManagerId);
      }
    }

    /**
     * @description Time tracking entries for team members.
     * @path /timeEntries/{timeEntryId}
     * @allow Owner of the entry (get, update). PM of the associated project (get). Admin (all).
     * @deny Users logging time for others or editing others' entries.
     * @principle Ownership-based writes with managerial read access.
     */
    match /timeEntries/{timeEntryId} {
      allow get: if isAdmin() || isOwner(resource.data.teamMemberId) || request.auth.uid == resource.data.projectManagerId;
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.teamMemberId;
      allow update: if resource != null && isOwner(resource.data.teamMemberId) && request.resource.data.teamMemberId == resource.data.teamMemberId;
      allow delete: if resource != null && (isAdmin() || isOwner(resource.data.teamMemberId));
    }

    /**
     * @description Client invoices and associated line items.
     * @path /invoices/{invoiceId}
     * @allow Admins, Global PMs, or the Project Manager linked to the invoice (get, list, write).
     * @deny General team members or sales reps not associated with the project.
     * @principle Role-based and relationship-based access for financial data.
     */
    match /invoices/{invoiceId} {
      allow get: if isAdmin() || isGlobalPM() || request.auth.uid == resource.data.projectManagerId;
      allow list: if isAdmin() || isGlobalPM();
      allow create, update: if isAdmin() || isGlobalPM() || (isSignedIn() && request.auth.uid == request.resource.data.projectManagerId);
      allow delete: if isAdmin() && resource != null;

      match /lineItems/{lineItemId} {
        allow get: if isAdmin() || isGlobalPM() || request.auth.uid == resource.data.projectManagerId;
        allow list: if isSignedIn();
        allow create: if (isAdmin() || isGlobalPM() || request.auth.uid == request.resource.data.projectManagerId) && request.resource.data.invoiceId == invoiceId;
        allow update: if resource != null && (isAdmin() || isGlobalPM() || request.auth.uid == resource.data.projectManagerId) && request.resource.data.invoiceId == resource.data.invoiceId;
        allow delete: if resource != null && (isAdmin() || isGlobalPM() || request.auth.uid == resource.data.projectManagerId);
      }
    }

    /**
     * @description Potential sales leads.
     * @path /leads/{leadId}
     * @allow Assigned sales representative (get, update) or Sales Manager (all).
     * @deny Team members not assigned to the lead.
     * @principle Sales ownership and managerial oversight.
     */
    match /leads/{leadId} {
      allow get: if isAdmin() || isSalesManager() || request.auth.uid == resource.data.assignedToId;
      allow list: if isAdmin() || isSalesManager() || (isSignedIn());
      allow create: if isAdmin() || isSalesManager() || (isSignedIn() && request.auth.uid == request.resource.data.assignedToId);
      allow update: if resource != null && (isAdmin() || isSalesManager() || request.auth.uid == resource.data.assignedToId) && request.resource.data.assignedToId == resource.data.assignedToId;
      allow delete: if isAdmin() || isSalesManager();
    }

    /**
     * @description Marketing and sales follow-up activities.
     * @path /followUps/{followUpId}
     * @allow The assigned owner, or any manager/member associated with the linked Client, Lead, or Project.
     * @deny Unrelated team members.
     * @principle Multi-entity relationship authorization via complex denormalization.
     */
    match /followUps/{followUpId} {
      allow get: if isAdmin() || isSalesManager() || isGlobalPM() || 
                    request.auth.uid == resource.data.assignedToId || 
                    request.auth.uid in resource.data.clientProjectManagerIds || 
                    request.auth.uid == resource.data.leadAssignedToId || 
                    request.auth.uid == resource.data.projectManagerId || 
                    request.auth.uid in resource.data.projectMemberIds;
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if resource != null && (isAdmin() || isSalesManager() || isGlobalPM() || request.auth.uid == resource.data.assignedToId);
      allow delete: if resource != null && (isAdmin() || isSalesManager() || isGlobalPM() || request.auth.uid == resource.data.assignedToId);
    }
  }
}